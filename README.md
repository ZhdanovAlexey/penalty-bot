# Калькулятор неустойки ДДУ - Telegram Bot

Бот для расчета неустойки за просрочку передачи объекта долевого строительства в соответствии с ФЗ.

## Функциональность

- Расчет неустойки по ДДУ с учетом:
  - Типа участника (ФЛ/ЮЛ)
  - Уникальности объекта
  - Моратория на начисление неустойки
  - Ставки рефинансирования ЦБ на дату крайнего срока передачи объекта
- Данные о ставках и мораториях загружаются из Google Sheets
- Проверка подписки пользователя на канал перед использованием бота

## Логика расчета

1. Расчет начинается со следующего дня после крайней даты передачи объекта по ДДУ
2. Используется фиксированная ставка рефинансирования на дату крайнего срока передачи объекта
3. Дни, на которые установлен мораторий, не учитываются при расчете
4. В зависимости от типа участника и уникальности объекта применяются разные формулы:
   - ФЛ и дом НЕ уникален: Неустойка = (1/150) * ставка_рефинансирования * сумма_ДДУ * кол-во_дней_без_моратория
   - ЮЛ и дом НЕ уникален: Неустойка = (1/300) * ставка_рефинансирования * сумма_ДДУ * кол-во_дней_без_моратория
   - Если дом уникальный (ФЛ или ЮЛ): Неустойка = (1/300) * ставка_рефинансирования * сумма_ДДУ * кол-во_дней_без_моратория
   - Если неустойка > 5% от суммы ДДУ для уникального объекта, то неустойка = 5% от суммы ДДУ

## Требования

- Python 3.8+
- Токен бота Telegram (получить у [@BotFather](https://t.me/BotFather))
- Доступ к Google Sheets API
- Service account для Google API
- Бот должен быть администратором канала для проверки подписки

## Установка

1. Клонируйте репозиторий:
   ```
   git clone <url-репозитория>
   cd <директория-проекта>
   ```

2. Создайте виртуальное окружение и установите зависимости:
   ```
   python -m venv .venv
   source .venv/bin/activate  # Для Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. Настройка Google Sheets API:
   - Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
   - Создайте новый проект
   - Включите Google Sheets API
   - Создайте Service Account и скачайте ключ в формате JSON
   - Поместите файл ключа в папку `data/service_account.json`
   - Создайте таблицу Google Sheets и предоставьте доступ на чтение вашему Service Account
   - Подробные инструкции находятся в файле `data/README.md`

4. Настройка конфигурации:
   - Скопируйте файл `.env.example` в `.env`
   - Укажите ваш токен Telegram бота и ID таблицы Google Sheets

5. Настройка канала:
   - Создайте или используйте существующий канал Telegram
   - Добавьте бота в качестве администратора канала
   - ID канала указан в файле `handlers/user.py` в константе `CHANNEL_ID` 
     (при необходимости замените на ID вашего канала)

## Структура таблицы Google Sheets

Таблица должна содержать следующие колонки:
1. Дата (в формате ДД.ММ.ГГГГ)
2. Ставка рефинансирования (в формате "XX%")
3. Мораторий (0 - нет, 1 - есть)

Пример:
```
Дата         | Ставка рефинансирования | Мораторий
01.01.2024   | 10%                     | 0
07.01.2024   | 10%                     | 1
...          | ...                     | ...
```

В папке `data/example_data.csv` есть пример данных, который можно импортировать в Google Sheets.

## Проверка настройки

Перед запуском бота рекомендуется проверить правильность настройки окружения и подключения к Google Sheets с помощью специального скрипта:

```
python check_connection.py
```

Скрипт проверит:
- Наличие необходимых переменных окружения
- Наличие файла сервисного аккаунта
- Подключение к Google Sheets и получение данных

## Запуск бота

После успешной проверки настройки вы можете запустить бота:

```
python bot.py
```

## Использование бота

1. Отправьте команду `/start` боту
2. Если вы не подписаны на канал, бот предложит подписаться и проверить подписку
3. После подтверждения подписки, следуйте инструкциям бота для ввода:
   - Стоимости объекта по ДДУ
   - Крайней даты передачи объекта по ДДУ
   - Даты для расчета неустойки
   - Типа участника долевого строительства
   - Информации об уникальности объекта

После ввода всех данных бот рассчитает и отобразит итоговую неустойку.

## База данных

Бот использует SQLite для хранения следующей информации:

1. **Пользователи и их подписки**
   - ID пользователя
   - Имя и фамилия
   - Username
   - Статус подписки
   - Дата добавления/обновления

2. **История расчетов**
   - ID пользователя
   - Параметры расчета (сумма договора, даты, тип участника и т.д.)
   - Результаты расчета (сумма неустойки, дни просрочки)
   - Дата расчета

Файл базы данных создается в директории `data/bot_database.sqlite`. Для резервного копирования достаточно скопировать этот файл.

### Административные команды

Администраторы бота (ID которых указаны в массиве `ADMIN_IDS` в файле `handlers/user.py`) имеют доступ к дополнительным командам:

- `/admin` - отображает список доступных административных команд
- `/adduser` - добавляет пользователя в базу как подписанного по его ID
- `/stats` - отображает статистику использования бота: количество пользователей, расчетов и т.д.

## Сброс расчета

Используйте команду `/reset` для сброса текущего расчета и начала нового.

## Решение проблем

### Ошибка "Service account info was not in the expected format, missing fields"

Эта ошибка означает, что файл сервисного аккаунта (`data/service_account.json`) отсутствует или имеет неправильный формат.

**Решение:**
1. Убедитесь, что файл `data/service_account.json` существует
2. Проверьте, что файл содержит все необходимые поля (см. `data/README.md`)
3. Скачайте новый файл ключа сервисного аккаунта из Google Cloud Console, если необходимо

### Ошибка при получении данных из Google Sheets

Если вы получаете ошибку при попытке доступа к данным в Google Sheets:

**Решение:**
1. Убедитесь, что вы указали правильный ID таблицы в переменной `SPREADSHEET_ID` в файле `.env`
2. Проверьте, что вы предоставили доступ к таблице для сервисного аккаунта (email из поля `client_email` в файле service_account.json)
3. Убедитесь, что таблица содержит данные в правильном формате (см. структуру выше)
4. Запустите скрипт проверки `python check_connection.py` для диагностики проблемы

### Ошибка при проверке подписки на канал

Если бот не может проверить подписку пользователя на канал:

**Решение:**
1. Убедитесь, что бот добавлен в качестве администратора канала
2. Проверьте правильность ID канала в константе `CHANNEL_ID` в файле `handlers/user.py`
3. Если ID канала начинается с -100, убедитесь, что канал публичный или имеет @username

### Проблемы с базой данных

Если бот сообщает об ошибках, связанных с базой данных:

**Решение:**
1. Убедитесь, что директория `data` существует и доступна для записи
2. Проверьте права на запись в файл `data/bot_database.sqlite`
3. Если база данных повреждена, удалите файл `data/bot_database.sqlite` и перезапустите бота (база будет создана заново)
4. Для восстановления базы данных из резервной копии просто замените файл `data/bot_database.sqlite` вашей копией

### Ошибка "Вы не подписаны на канал" несмотря на подписку

Если пользователь подписан на канал, но бот по-прежнему сообщает о необходимости подписки:

**Решение:**
1. Проверьте, что бот является администратором канала
2. Попробуйте нажать кнопку "Проверить подписку" несколько раз
3. Администратор может вручную добавить пользователя как подписанного с помощью команды `/adduser`
4. В крайнем случае, пользователь может отписаться и подписаться заново на канал 